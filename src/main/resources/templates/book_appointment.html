<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Appointment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<h1>Book an Appointment</h1>

<!-- Dropdown for selecting a doctor -->
<form id="appointmentForm">
    <label for="doctor_id">Doctor:</label>
    <select id="doctor_id" name="doctor_id" required>
        <option value="" disabled selected>Select a doctor</option>
        <!-- Options will be populated here dynamically -->
    </select>

    <label for="date">Select Date:</label>
    <input type="date" id="date" name="date" min="" required>


    <label for="time_slots">Select Time:</label>
    <select id="time_slots" name="time_slots" disabled>
        <option value="" disabled selected>Select a time</option>
        <!-- Options will be populated here dynamically -->
    </select>

    <label for="comment">Comment:</label>
    <textarea id="comment" name="comment" placeholder="Optional comment..."></textarea>

    <button type="submit" id="bookAppointment" disabled>Book Appointment</button>
</form>

<!-- Loading indicator -->
<div id="loading" style="display:none;">Loading...</div>

<!-- Link to view all doctors -->
<p>
    <a href="/doctors">View All Doctors</a>
</p>

<script>
    $(document).ready(function() {
        // Set the minimum date to today to prevent past appointments
        const today = new Date().toISOString().split('T')[0];
        $('#date').attr('min', today);

        // Fetch and populate doctors dropdown
        $.ajax({
            url: '/doctors/list', // Call to the JSON endpoint for doctors
            method: 'GET',
            beforeSend: function() {
                $('#loading').show(); // Show loading indicator
            },
            success: function(data) {
                $('#loading').hide(); // Hide loading indicator
                data.forEach(function(doctor) {
                    $('#doctor_id').append(new Option(doctor.name, doctor.id)); // Populate dropdown
                });
            },
            error: function(xhr, status, error) {
                $('#loading').hide(); // Hide loading indicator
                console.error('Error fetching doctors:', error); // Log error
                alert('Error fetching doctors');
            }
        });

        // Fetch available times when a doctor and date are selected
        $('#doctor_id, #date').on('change', function() {
            const doctorId = $('#doctor_id').val();
            const selectedDate = $('#date').val();

            if (doctorId && selectedDate) {
                fetchAvailableTimes(doctorId, selectedDate); // Fetch available times for the selected doctor and date
            } else {
                $('#time_slots').empty().prop('disabled', true); // Clear times and disable if doctor or date not selected
                $('#bookAppointment').prop('disabled', true); // Disable book button
            }
        });

        // Define fetchAvailableTimes as a reusable function
        function fetchAvailableTimes(doctorId, selectedDate) {
            $.ajax({
                url: `/appointments/times?doctor_id=${doctorId}&date=${selectedDate}`,
                method: 'GET',
                beforeSend: function() {
                    $('#loading').show(); // Show loading indicator
                },
                success: function(times) {
                    $('#loading').hide(); // Hide loading indicator
                    $('#time_slots').empty().prop('disabled', false); // Clear previous times and enable dropdown

                    if (times.length === 0) {
                        $('#time_slots').append(new Option('No available times.', '', true, true)).prop('disabled', true);
                        $('#bookAppointment').prop('disabled', true); // Disable book button
                    } else {
                        $('#time_slots').append(new Option('Select a time', '', true, true)); // Add default option
                        times.forEach(function(time) {
                            $('#time_slots').append(new Option(time, time)); // Populate with available times
                        });
                        $('#bookAppointment').prop('disabled', true); // Initially keep button disabled until time is selected
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide(); // Hide loading indicator
                    console.error('Error fetching available times:', error); // Log error
                    alert('Error fetching available times');
                }
            });
        }

        // Enable booking button only when a time slot is selected
        $('#time_slots').on('change', function() {
            const selectedTime = $(this).val();
            if (selectedTime) {
                $('#bookAppointment').prop('disabled', false); // Enable button if a time is selected
            } else {
                $('#bookAppointment').prop('disabled', true); // Disable button if no time is selected
            }
        });

        // Handle booking appointment
        $('#appointmentForm').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            const doctorId = $('#doctor_id').val();
            const selectedDate = $('#date').val();
            const selectedTime = $('#time_slots').val();
            const comment = $('#comment').val();

            // Perform AJAX request to book the appointment
            $.ajax({
                url: '/appointments/book', // Endpoint to handle booking
                method: 'POST',
                data: {
                    doctor_id: doctorId,
                    date: selectedDate,
                    time: selectedTime,
                    comment: comment // Include comment in the data sent to the server
                },
                success: function(response) {
                    alert('Appointment booked successfully!'); // Notify user of success

                    // Clear and reset form fields
                    $('#appointmentForm')[0].reset(); // Reset the form to clear inputs
                    $('#time_slots').empty().prop('disabled', true); // Clear and disable time slots dropdown
                    $('#bookAppointment').prop('disabled', true); // Disable book button

                    // Trigger change event on doctor and date fields to re-fetch and filter available times
                    $('#doctor_id').trigger('change');
                    $('#date').trigger('change');
                },
                error: function() {
                    alert('Error booking the appointment. Please try again.');
                }
            });
        });
    });

</script>

</body>
</html>


